仕様書 Version 0.001

1. 概要

Bad Apple!! 等の 1bit 白黒動画を、
ESP32 / RP2040 / CH32V などの 小規模MCU で

極小メモリ

フレームバッファ最小

低デコード負荷

で再生することを目的とした
8×8ブロック固定・前フレーム差分指向コーデックである。

本方式は **常に「元ビット列以上に膨らまない」**ことを設計原則とする。

2. 設計思想（最重要）

ブロック（8×8 = 64bit）が最小・唯一の意味単位

命令は ブロック境界を越えない

後続データの終端は
「ブロックサイズ到達」で自動決定される

可変長であっても
終端コードは一切持たない

前フレーム参照は
必ず同一ブロック座標

3. 基本仕様
3.1 ピクセル・ブロック
項目	内容
ピクセル	1bit（0=黒, 1=白）
ブロックサイズ	8×8 ピクセル
ブロック表現	8バイト（1行=1byte, MSBが左）
ブロック容量	64bit 固定
3.2 フレーム構成

フレームは ブロック列の集合

ブロック数はヘッダで与えられる

暗黙のフレーム終了条件を持つ（後述）

3.3 カーソル（ブロック座標）

座標系： (x, y) ブロック単位

初期値： (0, 0)

進行方向：
左 → 右 → 行末で改行 → 下

自動動作

描画系命令実行後：x += 1

x == block_width → x = 0, y += 1

y == block_height → フレーム終了

※ 明示的 END_FRAME は任意（デバッグ用）

4. ファイルフォーマット
4.1 ヘッダ
uint16  header_size
uint8   blocks_x
uint8   blocks_y
uint8[] reserved (optional)


例（128×64）：

blocks_x = 16

blocks_y = 8

5. 命令フォーマット（最重要）
5.1 基本構造
1 byte instruction

[ bit7 | bit6..0 ]

bit	意味
bit7	命令種別分岐
bit6..0	命令コード / 引数
5.2 命令分岐木（分木構造）
bit7 = 0 → アトリビュート命令（描画系）
bit7 = 1 → ロジック命令（制御系）

6. アトリビュート命令（bit7 = 0）
6.1 一覧
bit6..0	命令	後続	説明
0000000	START_FRAME	なし	フレーム開始・カーソル初期化
0000001	MASTER_BLOCK	8byte	生ブロック描画
0000010	RLE_BLOCK_BLACK	可変	RLE（黒始まり）
0000011	RLE_BLOCK_WHITE	可変	RLE（白始まり）
0000100	DELTA_FRAME_BIT	8byte or 可変	前フレーム差分
0000101	MASTER_FRAME	可変	フレーム全体raw
0010000	BLOCK_FILL_BLACK	なし	全黒
0010001	BLOCK_FILL_WHITE	なし	全白
0010010	BLOCK_INVERT	なし	前フレーム反転
6.2 BLOCK_FILL / INVERT

後続データなし

ブロック内容は即時決定

描画後カーソル自動進行

6.3 MASTER_BLOCK

後続 8バイト固定

そのままブロック内容として使用

6.4 RLE_BLOCK（重要）
符号形式
[ value(1bit) | run_length(7bit) ]


run_length: 1〜127

value: 0=黒, 1=白

終了条件（明文化）

RLE 展開結果が 64bit に到達した時点で終了

終端コードなし

余剰データは次命令扱い

6.5 DELTA_FRAME_BIT（最重要）
意味

前フレーム同一座標ブロックとの差分

モード

XORモード

後続 8バイト固定

current = prev XOR data

RLEモード

RLE 展開後 XOR 適用

64bit 到達で終了

終端なし

7. ロジック命令（bit7 = 1）
7.1 一覧
bit6..4	bit3..0	命令	説明
000	n	SKIP_BLOCK	n+1 ブロックコピー
001	n	FOR	次命令を n+1 回
010	0000	END_FRAME	明示フレーム終了
011	xxxx	NOP	何もしない
7.2 SKIP_BLOCK

前フレームの同一座標ブロックをコピー

ブロック単位でのみ作用

カーソルは指定回数分自動進行

8. フレーム終了条件（重要）

フレームは以下の いずれかで終了する。

カーソルが (blocks_x, blocks_y) に到達

END_FRAME 命令を受信

9. フォールバック保証

圧縮結果が不利な場合：

START_FRAME
MASTER_FRAME
  raw blocks...
END_FRAME


これにより、

必ず元ビット列 + 定数オーバヘッド以下

が保証される。

10. デコード保証条件

すべての命令は
64bit ブロック境界内で完結

終端条件は
サイズ到達のみ

デコーダは
追加メタ情報を一切必要としない

11. 拡張方針

bit7=0 空きコード：描画系拡張

bit7=1 空きグループ：制御拡張

後段 entropy coding は ブロック内限定
